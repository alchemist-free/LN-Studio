<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#121212">
    <title>LN Studio</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #121212;
            color: #808080;
            overflow-x: hidden;
        }
        .container { max-width: 100%; margin: 0 auto; }
        .btn-primary { 
            background: #494458; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 12px; 
            font-weight: bold; 
            cursor: pointer;
            width: 100%;
        }
        .btn-secondary { 
            background: #202020; 
            color: #808080; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 12px; 
            font-weight: bold; 
            cursor: pointer;
        }
        .input { 
            background: #121212; 
            color: white; 
            border: none; 
            padding: 12px 16px; 
            border-radius: 12px; 
            width: 100%;
            outline: none;
        }
        .card { 
            background: #202020; 
            border-radius: 16px; 
            padding: 16px; 
            margin-bottom: 12px;
        }
        .tab { 
            padding: 8px 16px; 
            color: #808080; 
            border: none; 
            background: none; 
            cursor: pointer; 
            white-space: nowrap;
        }
        .tab-active { 
            color: white; 
            border-bottom: 2px solid #494458; 
        }
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #202020;
            display: flex;
            justify-content: space-around;
            padding: 12px;
            z-index: 100;
        }
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            background: none;
            border: none;
            color: #808080;
            cursor: pointer;
            font-size: 12px;
        }
        .nav-btn.active { color: white; }
        .header {
            background: #202020;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .scroll-container {
            overflow-x: auto;
            display: flex;
            gap: 24px;
            padding: 16px;
            -webkit-overflow-scrolling: touch;
        }
        .scroll-container::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script>
        'use strict';
        const { useState, useEffect } = React;
        const h = React.createElement;

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('login');
            const [projects, setProjects] = useState([]);
            const [currentProject, setCurrentProject] = useState(null);
            const [characters, setCharacters] = useState([]);
            const [fontSize, setFontSize] = useState('medium');
            const [language, setLanguage] = useState('ru');
            const [activeTab, setActiveTab] = useState('all');
            const [sortBy, setSortBy] = useState('date');
            const [searchQuery, setSearchQuery] = useState('');
            
            const [loginForm, setLoginForm] = useState({ nickname: '' });
            const [projectForm, setProjectForm] = useState({ 
                title: '', description: '', poster: '', genres: '', status: '–í –ø—Ä–æ—Ü–µ—Å—Å–µ' 
            });
            const [chapterForm, setChapterForm] = useState({ 
                volumeNumber: 1, number: 1, title: '', content: '', notes: '' 
            });
            const [characterForm, setCharacterForm] = useState({ 
                name: '', role: '', description: '' 
            });

            useEffect(() => {
                const data = localStorage.getItem('ln-studio');
                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        if (parsed.user) { 
                            setUser(parsed.user); 
                            setView('library'); 
                        }
                        setProjects(parsed.projects || []);
                        setCharacters(parsed.characters || []);
                        setLanguage(parsed.language || 'ru');
                        setFontSize(parsed.fontSize || 'medium');
                    } catch (e) {
                        console.error('Parse error:', e);
                    }
                }
            }, []);

            useEffect(() => {
                if (user) {
                    localStorage.setItem('ln-studio', JSON.stringify({ 
                        user, projects, characters, language, fontSize 
                    }));
                }
            }, [user, projects, characters, language, fontSize]);

            const login = () => {
                if (!loginForm.nickname.trim()) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º!');
                setUser({ nickname: loginForm.nickname, date: new Date().toISOString() });
                setView('library');
            };

            const logout = () => {
                if (confirm('–í—ã–π—Ç–∏?')) {
                    setUser(null);
                    setView('login');
                    setProjects([]);
                    setCharacters([]);
                    localStorage.removeItem('ln-studio');
                }
            };

            const createProject = () => {
                if (!projectForm.title) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ!');
                const p = { 
                    ...projectForm, 
                    id: Date.now(), 
                    volumes: [], 
                    author: user.nickname, 
                    date: new Date().toISOString() 
                };
                setProjects([...projects, p]);
                setProjectForm({ 
                    title: '', description: '', poster: '', genres: '', status: '–í –ø—Ä–æ—Ü–µ—Å—Å–µ' 
                });
                setView('library');
            };

            const deleteProject = (id, ev) => {
                ev.stopPropagation();
                if (confirm('–£–¥–∞–ª–∏—Ç—å?')) {
                    setProjects(projects.filter(p => p.id !== id));
                }
            };

            const openProject = (p) => { 
                setCurrentProject(p); 
                setView('detail'); 
            };

            const saveChapter = (draft) => {
                if (!chapterForm.title || !chapterForm.content) {
                    return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ç–µ–∫—Å—Ç!');
                }
                const ch = { 
                    ...chapterForm, 
                    isDraft: draft, 
                    id: Date.now(), 
                    date: new Date().toISOString() 
                };
                const updated = projects.map(p => {
                    if (p.id === currentProject.id) {
                        let vols = Array.isArray(p.volumes) ? [...p.volumes] : [];
                        let idx = vols.findIndex(v => v.number === ch.volumeNumber);
                        if (idx === -1) {
                            vols.push({ number: ch.volumeNumber, chapters: [ch] });
                        } else {
                            vols[idx].chapters.push(ch);
                        }
                        return { ...p, volumes: vols };
                    }
                    return p;
                });
                setProjects(updated);
                setCurrentProject(updated.find(p => p.id === currentProject.id));
                if (!draft) {
                    setChapterForm({ volumeNumber: 1, number: 1, title: '', content: '', notes: '' });
                    setView('detail');
                } else {
                    alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ —á–µ—Ä–Ω–æ–≤–∏–∫–∏!');
                }
            };

            const addCharacter = () => {
                if (!characterForm.name) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è!');
                const c = { 
                    ...characterForm, 
                    id: Date.now(), 
                    projectId: currentProject.id 
                };
                setCharacters([...characters, c]);
                setCharacterForm({ name: '', role: '', description: '' });
            };

            const getStats = () => {
                let totalWords = 0, inProgress = 0, completed = 0, drafts = 0;
                projects.forEach(p => {
                    if (p.status === '–í –ø—Ä–æ—Ü–µ—Å—Å–µ') inProgress++;
                    if (p.status === '–ó–∞–≤–µ—Ä—à–µ–Ω–æ') completed++;
                    if (Array.isArray(p.volumes)) {
                        p.volumes.forEach(v => {
                            if (Array.isArray(v.chapters)) {
                                v.chapters.forEach(ch => {
                                    totalWords += ch.content.split(/\s+/).filter(x => x).length;
                                    if (ch.isDraft) drafts++;
                                });
                            }
                        });
                    }
                });
                return { totalWords, novels: projects.length, inProgress, completed, drafts };
            };

            const filtered = projects.filter(p => {
                if (activeTab === 'progress' && p.status !== '–í –ø—Ä–æ—Ü–µ—Å—Å–µ') return false;
                if (activeTab === 'completed' && p.status !== '–ó–∞–≤–µ—Ä—à–µ–Ω–æ') return false;
                if (activeTab === 'drafts') {
                    let has = false;
                    if (Array.isArray(p.volumes)) {
                        p.volumes.forEach(v => {
                            if (Array.isArray(v.chapters)) {
                                v.chapters.forEach(ch => { 
                                    if (ch.isDraft) has = true; 
                                });
                            }
                        });
                    }
                    if (!has) return false;
                }
                if (searchQuery && !p.title.toLowerCase().includes(searchQuery.toLowerCase())) {
                    return false;
                }
                return true;
            }).sort((a, b) => {
                if (sortBy === 'date') {
                    return new Date(b.date) - new Date(a.date);
                }
                return a.title.localeCompare(b.title);
            });

            // LOGIN
            if (view === 'login') {
                return h('div', { style: { minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '24px' } },
                    h('div', { style: { width: '100%', maxWidth: '400px', background: '#202020', padding: '32px', borderRadius: '24px' } },
                        h('div', { style: { textAlign: 'center', marginBottom: '32px' } },
                            h('div', { style: { fontSize: '64px', marginBottom: '16px' } }, 'üìö'),
                            h('h1', { style: { fontSize: '32px', fontWeight: 'bold', color: '#494458', marginBottom: '8px' } }, 'LN Studio'),
                            h('p', { style: { color: '#808080' } }, '–†–µ–¥–∞–∫—Ç–æ—Ä –ª–∞–π—Ç –Ω–æ–≤–µ–ª–ª')
                        ),
                        h('input', {
                            type: 'text',
                            placeholder: '–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º',
                            value: loginForm.nickname,
                            onChange: (e) => setLoginForm({ nickname: e.target.value }),
                            onKeyPress: (e) => { if (e.key === 'Enter') login(); },
                            className: 'input',
                            style: { marginBottom: '16px' }
                        }),
                        h('button', { onClick: login, className: 'btn-primary' }, '–í–æ–π—Ç–∏')
                    )
                );
            }

            // LIBRARY
            if (view === 'library') {
                return h('div', { style: { minHeight: '100vh', paddingBottom: '80px' } },
                    h('div', { className: 'header' },
                        h('div', { style: { width: '40px', height: '40px', borderRadius: '50%', background: '#494458', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '20px' } }, 'üìö'),
                        h('input', {
                            type: 'text',
                            placeholder: '–ü–æ–∏—Å–∫...',
                            value: searchQuery,
                            onChange: (e) => setSearchQuery(e.target.value),
                            className: 'input',
                            style: { flex: 1 }
                        }),
                        h('button', { onClick: () => setView('settings'), style: { background: 'none', border: 'none', fontSize: '20px', color: '#808080', cursor: 'pointer' } }, '‚öôÔ∏è'),
                        h('button', { onClick: () => setView('new'), style: { background: 'none', border: 'none', fontSize: '24px', color: '#808080', cursor: 'pointer' } }, '‚ûï')
                    ),
                    h('div', { className: 'scroll-container' },
                        ['all', 'progress', 'completed', 'drafts'].map(tab =>
                            h('button', {
                                key: tab,
                                onClick: () => setActiveTab(tab),
                                className: 'tab' + (activeTab === tab ? ' tab-active' : ''),
                                style: { color: activeTab === tab ? 'white' : '#808080' }
                            }, tab === 'all' ? '–í—Å–µ' : tab === 'progress' ? '–í –ø—Ä–æ—Ü–µ—Å—Å–µ' : tab === 'completed' ? '–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ' : '–ß–µ—Ä–Ω–æ–≤–∏–∫–∏')
                        )
                    ),
                    h('div', { style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '12px 16px' } },
                        h('span', { style: { color: '#808080' } }, filtered.length + ' –≤—Å–µ–≥–æ'),
                        h('select', {
                            value: sortBy,
                            onChange: (e) => setSortBy(e.target.value),
                            style: { background: '#202020', color: '#808080', border: 'none', padding: '8px 16px', borderRadius: '20px' }
                        },
                            h('option', { value: 'date' }, '–ü–æ –¥–∞—Ç–µ'),
                            h('option', { value: 'title' }, '–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é')
                        )
                    ),
                    h('div', { style: { padding: '0 16px' } },
                        filtered.length === 0 ?
                            h('div', { style: { textAlign: 'center', paddingTop: '80px' } },
                                h('div', { style: { fontSize: '64px', marginBottom: '16px' } }, 'üìù'),
                                h('p', { style: { color: '#808080' } }, '–ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–π')
                            )
                            : filtered.map(p => {
                                let w = 0, c = 0;
                                if (Array.isArray(p.volumes)) {
                                    p.volumes.forEach(v => {
                                        if (Array.isArray(v.chapters)) {
                                            v.chapters.forEach(ch => {
                                                if (!ch.isDraft) {
                                                    w += ch.content.split(/\s+/).filter(x => x).length;
                                                    c++;
                                                }
                                            });
                                        }
                                    });
                                }
                                return h('div', {
                                    key: p.id,
                                    onClick: () => openProject(p),
                                    className: 'card',
                                    style: { display: 'flex', gap: '12px', cursor: 'pointer' }
                                },
                                    p.poster ?
                                        h('img', { src: p.poster, style: { width: '96px', height: '128px', objectFit: 'cover', borderRadius: '12px', flexShrink: 0 } })
                                        : h('div', { style: { width: '96px', height: '128px', background: '#494458', borderRadius: '12px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '32px', flexShrink: 0 } }, 'üìñ'),
                                    h('div', { style: { flex: 1, minWidth: 0 } },
                                        h('h3', { style: { color: 'white', fontWeight: 'bold', marginBottom: '4px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' } }, p.title),
                                        h('p', { style: { fontSize: '14px', color: '#808080', marginBottom: '8px' } }, c + ' –≥–ª–∞–≤ ‚Ä¢ ' + w + ' —Å–ª–æ–≤'),
                                        p.description && h('p', { style: { fontSize: '14px', color: '#808080', overflow: 'hidden', textOverflow: 'ellipsis', display: '-webkit-box', WebkitLineClamp: 2, WebkitBoxOrient: 'vertical' } }, p.description),
                                        p.genres && h('div', { style: { display: 'flex', gap: '8px', marginTop: '8px', flexWrap: 'wrap' } },
                                            p.genres.split(',').slice(0, 2).map((g, i) =>
                                                h('span', { key: i, style: { fontSize: '12px', background: '#494458', color: 'white', padding: '4px 8px', borderRadius: '4px' } }, g.trim())
                                            )
                                        )
                                    ),
                                    h('button', { onClick: (e) => deleteProject(p.id, e), style: { background: 'none', border: 'none', fontSize: '20px', color: '#808080', cursor: 'pointer' } }, '‚ãÆ')
                                );
                            })
                    ),
                    h('div', { className: 'bottom-nav' },
                        h('button', { className: 'nav-btn active', onClick: () => setView('library') },
                            h('div', { style: { fontSize: '24px' } }, 'üìö'),
                            h('span', null, '–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞')
                        ),
                        h('button', { className: 'nav-btn', onClick: () => setView('profile') },
                            h('div', { style: { fontSize: '24px' } }, 'üë§'),
                            h('span', null, '–ü—Ä–æ—Ñ–∏–ª—å')
                        )
                    )
                );
            }

            // NEW PROJECT
            if (view === 'new') {
                return h('div', { style: { minHeight: '100vh', padding: '16px' } },
                    h('button', { onClick: () => setView('library'), style: { background: 'none', border: 'none', fontSize: '24px', color: '#808080', marginBottom: '16px', cursor: 'pointer' } }, '‚Üê'),
                    h('div', { style: { maxWidth: '600px', margin: '0 auto', background: '#202020', padding: '24px', borderRadius: '16px' } },
                        h('input', {
                            type: 'text',
                            placeholder: '–ù–∞–∑–≤–∞–Ω–∏–µ *',
                            value: pr
