<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#121212">
    <title>LN Studio</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #121212;
            color: #808080;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        .btn { 
            background: #494458; 
            color: white; 
            border: none; 
            padding: 14px 20px; 
            border-radius: 12px; 
            font-weight: bold; 
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            font-family: inherit;
        }
        .btn:active { opacity: 0.8; }
        .input { 
            background: #121212; 
            color: white; 
            border: none; 
            padding: 14px 16px; 
            border-radius: 12px; 
            width: 100%;
            font-size: 16px;
            font-family: inherit;
        }
        .input:focus { outline: none; }
        .card { 
            background: #202020; 
            border-radius: 16px; 
            padding: 16px; 
            margin-bottom: 12px;
        }
        .header {
            background: #202020;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #202020;
            display: flex;
            padding: 12px 0;
            z-index: 100;
        }
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: #808080;
            font-size: 12px;
            text-decoration: none;
            padding: 8px;
        }
        .nav-item.active { color: white; }
        .tabs {
            display: flex;
            gap: 24px;
            padding: 16px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .tabs::-webkit-scrollbar { display: none; }
        .tab {
            padding: 8px 0;
            color: #808080;
            white-space: nowrap;
            border-bottom: 2px solid transparent;
            font-size: 15px;
        }
        .tab.active {
            color: white;
            border-bottom-color: #494458;
        }
    </style>
</head>
<body>
    <div id="app"></div>
    <script>
        const state = {
            user: null,
            view: 'login',
            projects: [],
            currentProject: null,
            characters: [],
            fontSize: 'medium',
            language: 'ru',
            activeTab: 'all',
            sortBy: 'date',
            searchQuery: '',
            forms: {
                login: { nickname: '' },
                project: { title: '', description: '', poster: '', genres: '', status: '–í –ø—Ä–æ—Ü–µ—Å—Å–µ' },
                chapter: { volumeNumber: 1, number: 1, title: '', content: '', notes: '' },
                character: { name: '', role: '', description: '' }
            }
        };

        function loadData() {
            const data = localStorage.getItem('ln-studio');
            if (data) {
                try {
                    const parsed = JSON.parse(data);
                    if (parsed.user) {
                        state.user = parsed.user;
                        state.view = 'library';
                    }
                    state.projects = parsed.projects || [];
                    state.characters = parsed.characters || [];
                    state.language = parsed.language || 'ru';
                    state.fontSize = parsed.fontSize || 'medium';
                } catch (e) {}
            }
        }

        function saveData() {
            localStorage.setItem('ln-studio', JSON.stringify({
                user: state.user,
                projects: state.projects,
                characters: state.characters,
                language: state.language,
                fontSize: state.fontSize
            }));
        }

        function render() {
            const app = document.getElementById('app');
            app.innerHTML = '';
            
            if (state.view === 'login') {
                app.innerHTML = `
                    <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 24px;">
                        <div style="width: 100%; max-width: 400px; background: #202020; padding: 32px; border-radius: 24px;">
                            <div style="text-align: center; margin-bottom: 32px;">
                                <div style="font-size: 64px; margin-bottom: 16px;">üìö</div>
                                <h1 style="font-size: 32px; font-weight: bold; color: #494458; margin-bottom: 8px;">LN Studio</h1>
                                <p style="color: #808080;">–†–µ–¥–∞–∫—Ç–æ—Ä –ª–∞–π—Ç –Ω–æ–≤–µ–ª–ª</p>
                            </div>
                            <input id="nickname" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º" class="input" style="margin-bottom: 16px;" value="${state.forms.login.nickname}">
                            <button class="btn" onclick="login()">–í–æ–π—Ç–∏</button>
                        </div>
                    </div>
                `;
                const input = document.getElementById('nickname');
                input.addEventListener('input', e => state.forms.login.nickname = e.target.value);
                input.addEventListener('keypress', e => { if (e.key === 'Enter') login(); });
            }
            
            else if (state.view === 'library') {
                const filtered = state.projects.filter(p => {
                    if (state.activeTab === 'progress' && p.status !== '–í –ø—Ä–æ—Ü–µ—Å—Å–µ') return false;
                    if (state.activeTab === 'completed' && p.status !== '–ó–∞–≤–µ—Ä—à–µ–Ω–æ') return false;
                    if (state.activeTab === 'drafts') {
                        let has = false;
                        if (p.volumes) p.volumes.forEach(v => v.chapters.forEach(ch => { if (ch.isDraft) has = true; }));
                        if (!has) return false;
                    }
                    if (state.searchQuery && !p.title.toLowerCase().includes(state.searchQuery.toLowerCase())) return false;
                    return true;
                }).sort((a, b) => {
                    if (state.sortBy === 'date') return new Date(b.date) - new Date(a.date);
                    return a.title.localeCompare(b.title);
                });

                app.innerHTML = `
                    <div style="min-height: 100vh; padding-bottom: 80px;">
                        <div class="header">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: #494458; display: flex; align-items: center; justify-content: center; font-size: 20px;">üìö</div>
                            <input id="search" type="text" placeholder="–ü–æ–∏—Å–∫..." class="input" style="flex: 1;" value="${state.searchQuery}">
                            <button onclick="state.view='settings'; render();" style="background: none; border: none; font-size: 20px; color: #808080; cursor: pointer;">‚öôÔ∏è</button>
                            <button onclick="state.view='new'; render();" style="background: none; border: none; font-size: 24px; color: #808080; cursor: pointer;">‚ûï</button>
                        </div>
                        <div class="tabs">
                            ${['all', 'progress', 'completed', 'drafts'].map(tab => `
                                <div class="tab ${state.activeTab === tab ? 'active' : ''}" onclick="state.activeTab='${tab}'; render();">
                                    ${tab === 'all' ? '–í—Å–µ' : tab === 'progress' ? '–í –ø—Ä–æ—Ü–µ—Å—Å–µ' : tab === 'completed' ? '–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ' : '–ß–µ—Ä–Ω–æ–≤–∏–∫–∏'}
                                </div>
                            `).join('')}
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px;">
                            <span>${filtered.length} –≤—Å–µ–≥–æ</span>
                            <select id="sort" style="background: #202020; color: #808080; border: none; padding: 8px 16px; border-radius: 20px;">
                                <option value="date" ${state.sortBy === 'date' ? 'selected' : ''}>–ü–æ –¥–∞—Ç–µ</option>
                                <option value="title" ${state.sortBy === 'title' ? 'selected' : ''}>–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é</option>
                            </select>
                        </div>
                        <div style="padding: 0 16px;">
                            ${filtered.length === 0 ? `
                                <div style="text-align: center; padding-top: 80px;">
                                    <div style="font-size: 64px; margin-bottom: 16px;">üìù</div>
                                    <p>–ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–π</p>
                                </div>
                            ` : filtered.map(p => {
                                let w = 0, c = 0;
                                if (p.volumes) p.volumes.forEach(v => v.chapters.forEach(ch => {
                                    if (!ch.isDraft) { w += ch.content.split(/\s+/).filter(x => x).length; c++; }
                                }));
                                return `
                                    <div class="card" onclick="openProject(${p.id})" style="display: flex; gap: 12px; cursor: pointer;">
                                        ${p.poster ? 
                                            `<img src="${p.poster}" style="width: 96px; height: 128px; object-fit: cover; border-radius: 12px; flex-shrink: 0;">` :
                                            `<div style="width: 96px; height: 128px; background: #494458; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 32px; flex-shrink: 0;">üìñ</div>`
                                        }
                                        <div style="flex: 1; min-width: 0;">
                                            <h3 style="color: white; font-weight: bold; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${p.title}</h3>
                                            <p style="font-size: 14px; margin-bottom: 8px;">${c} –≥–ª–∞–≤ ‚Ä¢ ${w} —Å–ª–æ–≤</p>
                                            ${p.description ? `<p style="font-size: 14px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">${p.description}</p>` : ''}
                                            ${p.genres ? `<div style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap;">
                                                ${p.genres.split(',').slice(0, 2).map(g => `<span style="font-size: 12px; background: #494458; color: white; padding: 4px 8px; border-radius: 4px;">${g.trim()}</span>`).join('')}
                                            </div>` : ''}
                                        </div>
                                        <button onclick="event.stopPropagation(); deleteProject(${p.id});" style="background: none; border: none; font-size: 20px; color: #808080; cursor: pointer;">‚ãÆ</button>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div class="bottom-nav">
                            <a class="nav-item active" onclick="state.view='library'; render();">
                                <div style="font-size: 24px;">üìö</div>
                                <span>–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</span>
                            </a>
                            <a class="nav-item" onclick="state.view='profile'; render();">
                                <div style="font-size: 24px;">üë§</div>
                                <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
                            </a>
                        </div>
                    </div>
                `;
                const searchInput = document.getElementById('search');
                searchInput.addEventListener('input', e => { state.searchQuery = e.target.value; render(); });
                const sortSelect = document.getElementById('sort');
                sortSelect.addEventListener('change', e => { state.sortBy = e.target.value; render(); });
            }
            
            else if (state.view === 'new') {
                app.innerHTML = `
                    <div style="min-height: 100vh; padding: 16px;">
                        <button onclick="state.view='library'; render();" style="background: none; border: none; font-size: 24px; color: #808080; margin-bottom: 16px; cursor: pointer;">‚Üê</button>
                        <div style="max-width: 600px; margin: 0 auto; background: #202020; padding: 24px; border-radius: 16px;">
                            <input id="title" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ *" class="input" style="margin-bottom: 16px;" value="${state.forms.project.title}">
                            <textarea id="desc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" class="input" style="margin-bottom: 16px; min-height: 100px; resize: vertical;">${state.forms.project.description}</textarea>
                            <input id="poster" type="text" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ—Å—Ç–µ—Ä" class="input" style="margin-bottom: 16px;" value="${state.forms.project.poster}">
                            <input id="genres" type="text" placeholder="–ñ–∞–Ω—Ä—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)" class="input" style="margin-bottom: 16px;" value="${state.forms.project.genres}">
                            <select id="status" class="input" style="margin-bottom: 16px;">
                                <option value="–í –ø—Ä–æ—Ü–µ—Å—Å–µ" ${state.forms.project.status === '–í –ø—Ä–æ—Ü–µ—Å—Å–µ' ? 'selected' : ''}>–í –ø—Ä–æ—Ü–µ—Å—Å–µ</option>
                                <option value="–ó–∞–≤–µ—Ä—à–µ–Ω–æ" ${state.forms.project.status === '–ó–∞–≤–µ—Ä—à–µ–Ω–æ' ? 'selected' : ''}>–ó–∞–≤–µ—Ä—à–µ–Ω–æ</option>
                                <option value="–ó–∞–º–æ—Ä–æ–∂–µ–Ω–æ" ${state.forms.project.status === '–ó–∞–º–æ—Ä–æ–∂–µ–Ω–æ' ? 'selected' : ''}>–ó–∞–º–æ—Ä–æ–∂–µ–Ω–æ</option>
                            </select>
                            <div style="display: flex; gap: 12px;">
                                <button onclick="state.view='library'; render();" style="flex: 1; background: #202020; color: #808080; border: none; padding: 14px; border-radius: 12px; font-weight: bold; cursor: pointer;">–û—Ç–º–µ–Ω–∞</button>
                                <button onclick="createProject();" class="btn" style="flex: 1;">–°–æ–∑–¥–∞—Ç—å</button>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('title').addEventListener('input', e => state.forms.project.title = e.target.value);
                document.getElementById('desc').addEventListener('input', e => state.forms.project.description = e.target.value);
                document.getElementById('poster').addEventListener('input', e => state.forms.project.poster = e.target.value);
                document.getElementById('genres').addEventListener('input', e => state.forms.project.genres = e.target.value);
                document.getElementById('status').addEventListener('change', e => state.forms.project.status = e.target.value);
            }
            
            else if (state.view === 'profile') {
                let totalWords = 0, inProgress = 0, completed = 0, drafts = 0;
                state.projects.forEach(p => {
                    if (p.status === '–í –ø—Ä–æ—Ü–µ—Å—Å–µ') inProgress++;
                    if (p.status === '–ó–∞–≤–µ—Ä—à–µ–Ω–æ') completed++;
                    if (p.volumes) p.volumes.forEach(v => v.chapters.forEach(ch => {
                        totalWords += ch.content.split(/\s+/).filter(x => x).length;
                        if (ch.isDraft) drafts++;
                    }));
                });

                app.innerHTML = `
                    <div style="min-height: 100vh; padding-bottom: 80px;">
                        <div style="background: #202020; padding: 24px;">
                            <div style="display: flex; justify-content: center; margin-bottom: 24px;">
                                <div style="width: 80px; height: 80px; border-radius: 50%; background: #494458; display: flex; align-items: center; justify-content: center; font-size: 40px;">üë§</div>
                            </div>
                            ${[
                                ['–ò–º—è:', state.user.nickname],
                                ['–ù–æ–≤–µ–ª–ª:', state.projects.length],
                                ['–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±—É–∫–≤:', totalWords],
                                ['–í –ø—Ä–æ—Ü–µ—Å—Å–µ:', inProgress],
                                ['–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π:', completed],
                                ['–ß–µ—Ä–Ω–æ–≤–∏–∫:', drafts]
                            ].map(([label, value]) => `
                                <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #121212;">
                                    <span style="color: #808080;">${label}</span>
                                    <span style="color: white;">${value}</span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="bottom-nav">
                            <a class="nav-item" onclick="state.view='library'; render();">
                                <div style="font-size: 24px;">üìö</div>
                                <span>–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</span>
                            </a>
                            <a class="nav-item active" onclick="state.view='profile'; render();">
                                <div style="font-size: 24px;">üë§</div>
                                <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
                            </a>
                        </div>
                    </div>
                `;
            }
            
            else if (state.view === 'settings') {
                app.innerHTML = `
                    <div style="min-height: 100vh; padding: 16px;">
                        <button onclick="state.view='library'; render();" style="background: none; border: none; font-size: 24px; color: #808080; margin-bottom: 16px; cursor: pointer;">‚Üê</button>
                        <div style="max-width: 600px; margin: 0 auto; background: #202020; padding: 24px; border-radius: 16px;">
                            <div style="margin-bottom: 24px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                    <span>–Ø–∑—ã–∫:</span>
                                    <select id="lang" style="background: #121212; color: white; padding: 8px 16px; border-radius: 8px; border: none;">
                                        <option value="ru" ${state.language === 'ru' ? 'selected' : ''}>üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
                                        <option value="en" ${state.language === 'en' ? 'selected' : ''}>üá¨üáß English</option>
                                        <option value="ja" ${state.language === 'ja' ? 'selected' : ''}>üáØüáµ Êó•Êú¨Ë™û</option>
                                        <option value="zh" ${state.language === 'zh' ? 'selected' : ''}>üá®üá≥ ‰∏≠Êñá</option>
                                    </select>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: cen
