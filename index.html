<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#121212">
    <title>LN Studio</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: #121212; 
            color: #808080; 
        }
        .tab-active { 
            color: white; 
            border-bottom: 2px solid #494458; 
        }
        .scroll-hidden::-webkit-scrollbar { display: none; }
        .scroll-hidden { 
            -ms-overflow-style: none; 
            scrollbar-width: none; 
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script>
        const React = window.React;
        const ReactDOM = window.ReactDOM;
        const { useState, useEffect } = React;

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('login');
            const [projects, setProjects] = useState([]);
            const [currentProject, setCurrentProject] = useState(null);
            const [characters, setCharacters] = useState([]);
            const [fontSize, setFontSize] = useState('medium');
            const [language, setLanguage] = useState('ru');
            const [activeTab, setActiveTab] = useState('all');
            const [sortBy, setSortBy] = useState('date');
            const [searchQuery, setSearchQuery] = useState('');
            const [loginForm, setLoginForm] = useState({ nickname: '' });
            const [projectForm, setProjectForm] = useState({ 
                title: '', description: '', poster: '', genres: '', status: 'Ð’ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐµ' 
            });
            const [chapterForm, setChapterForm] = useState({ 
                volumeNumber: 1, number: 1, title: '', content: '', notes: '' 
            });
            const [characterForm, setCharacterForm] = useState({ 
                name: '', role: '', description: '' 
            });

            useEffect(() => {
                const data = localStorage.getItem('ln-studio');
                if (data) {
                    const parsed = JSON.parse(data);
                    if (parsed.user) { 
                        setUser(parsed.user); 
                        setView('library'); 
                    }
                    setProjects(parsed.projects || []);
                    setCharacters(parsed.characters || []);
                    setLanguage(parsed.language || 'ru');
                    setFontSize(parsed.fontSize || 'medium');
                }
            }, []);

            useEffect(() => {
                if (user) {
                    localStorage.setItem('ln-studio', JSON.stringify({ 
                        user, projects, characters, language, fontSize 
                    }));
                }
            }, [user, projects, characters, language, fontSize]);

            useEffect(() => {
                const handleExit = () => { 
                    if (view === 'editor' && chapterForm.content) {
                        saveChapter(true); 
                    }
                };
                window.addEventListener('beforeunload', handleExit);
                return () => window.removeEventListener('beforeunload', handleExit);
            }, [view, chapterForm]);

            const login = () => {
                if (!loginForm.nickname.trim()) return alert('Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¸ÐºÐ½ÐµÐ¹Ð¼!');
                setUser({ nickname: loginForm.nickname, date: new Date().toISOString() });
                setView('library');
            };

            const logout = () => {
                if (confirm('Ð’Ñ‹Ð¹Ñ‚Ð¸?')) {
                    setUser(null); 
                    setView('login'); 
                    setProjects([]); 
                    setCharacters([]);
                    localStorage.removeItem('ln-studio');
                }
            };

            const createProject = () => {
                if (!projectForm.title) return alert('Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ!');
                const p = { 
                    ...projectForm, 
                    id: Date.now(), 
                    volumes: [], 
                    author: user.nickname, 
                    date: new Date().toISOString() 
                };
                setProjects([...projects, p]);
                setProjectForm({ 
                    title: '', description: '', poster: '', genres: '', status: 'Ð’ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐµ' 
                });
                setView('library');
            };

            const deleteProject = (id, ev) => {
                ev.stopPropagation();
                if (confirm('Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ?')) {
                    setProjects(projects.filter(p => p.id !== id));
                }
            };

            const openProject = (p) => { 
                setCurrentProject(p); 
                setView('detail'); 
            };

            const saveChapter = (draft) => {
                if (!chapterForm.title || !chapterForm.content) return;
                const ch = { 
                    ...chapterForm, 
                    isDraft: draft, 
                    id: Date.now(), 
                    date: new Date().toISOString() 
                };
                const updated = projects.map(p => {
                    if (p.id === currentProject.id) {
                        let vols = [...(p.volumes || [])];
                        let idx = vols.findIndex(v => v.number === ch.volumeNumber);
                        if (idx === -1) {
                            vols.push({ number: ch.volumeNumber, chapters: [ch] });
                        } else {
                            vols[idx].chapters.push(ch);
                        }
                        return { ...p, volumes: vols };
                    }
                    return p;
                });
                setProjects(updated);
                setCurrentProject(updated.find(p => p.id === currentProject.id));
                if (!draft) {
                    setChapterForm({ volumeNumber: 1, number: 1, title: '', content: '', notes: '' });
                    setView('detail');
                }
            };

            const addCharacter = () => {
                if (!characterForm.name) return alert('Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¸Ð¼Ñ!');
                const c = { 
                    ...characterForm, 
                    id: Date.now(), 
                    projectId: currentProject.id 
                };
                setCharacters([...characters, c]);
                setCharacterForm({ name: '', role: '', description: '' });
            };

            const getStats = () => {
                let totalWords = 0;
                let inProgress = 0;
                let completed = 0;
                let drafts = 0;
                projects.forEach(p => {
                    if (p.status === 'Ð’ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐµ') inProgress++;
                    if (p.status === 'Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾') completed++;
                    if (p.volumes) {
                        p.volumes.forEach(v => {
                            v.chapters.forEach(ch => {
                                totalWords += ch.content.split(/\s+/).filter(x => x).length;
                                if (ch.isDraft) drafts++;
                            });
                        });
                    }
                });
                return { totalWords, novels: projects.length, inProgress, completed, drafts };
            };

            const filtered = projects.filter(p => {
                if (activeTab === 'progress' && p.status !== 'Ð’ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐµ') return false;
                if (activeTab === 'completed' && p.status !== 'Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾') return false;
                if (activeTab === 'drafts') {
                    let has = false;
                    if (p.volumes) {
                        p.volumes.forEach(v => {
                            v.chapters.forEach(ch => { 
                                if (ch.isDraft) has = true; 
                            });
                        });
                    }
                    if (!has) return false;
                }
                if (searchQuery && !p.title.toLowerCase().includes(searchQuery.toLowerCase())) {
                    return false;
                }
                return true;
            }).sort((a, b) => {
                if (sortBy === 'date') {
                    return new Date(b.date) - new Date(a.date);
                }
                return a.title.localeCompare(b.title);
            });

            if (view === 'login') {
                return React.createElement('div', { 
                    className: 'min-h-screen flex items-center justify-center p-6' 
                },
                    React.createElement('div', { 
                        className: 'w-full max-w-sm p-8 rounded-3xl', 
                        style: { background: '#202020' } 
                    },
                        React.createElement('div', { className: 'text-center mb-8' },
                            React.createElement('div', { className: 'text-6xl mb-4' }, 'ðŸ“š'),
                            React.createElement('h1', { 
                                className: 'text-3xl font-bold mb-2', 
                                style: { color: '#494458' } 
                            }, 'LN Studio'),
                            React.createElement('p', { 
                                style: { color: '#808080' } 
                            }, 'Ð ÐµÐ´Ð°ÐºÑ‚Ð¾Ñ€ Ð»Ð°Ð¹Ñ‚ Ð½Ð¾Ð²ÐµÐ»Ð»')
                        ),
                        React.createElement('input', {
                            type: 'text',
                            placeholder: 'Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¸ÐºÐ½ÐµÐ¹Ð¼',
                            value: loginForm.nickname,
                            onChange: (ev) => setLoginForm({ nickname: ev.target.value }),
                            onKeyPress: (ev) => { if (ev.key === 'Enter') login(); },
                            className: 'w-full px-4 py-3 rounded-xl mb-4 outline-none',
                            style: { background: '#121212', color: 'white' }
                        }),
                        React.createElement('button', {
                            onClick: login,
                            className: 'w-full py-3 rounded-xl font-bold text-white',
                            style: { background: '#494458' }
                        }, 'Ð’Ð¾Ð¹Ñ‚Ð¸')
                    )
                );
            }

            if (view === 'library') {
                return React.createElement('div', { 
                    className: 'min-h-screen', 
                    style: { paddingBottom: '80px' } 
                },
                    React.createElement('div', { 
                        className: 'p-4 flex items-center gap-3', 
                        style: { background: '#202020' } 
                    },
                        React.createElement('div', { 
                            className: 'w-10 h-10 rounded-full flex items-center justify-center text-2xl', 
                            style: { background: '#494458' } 
                        }, 'ðŸ“š'),
                        React.createElement('input', {
                            type: 'text',
                            placeholder: 'ÐŸÐ¾Ð¸ÑÐº...',
                            value: searchQuery,
                            onChange: (ev) => setSearchQuery(ev.target.value),
                            className: 'flex-1 px-4 py-2 rounded-xl outline-none',
                            style: { background: '#121212', color: 'white' }
                        }),
                        React.createElement('button', { 
                            onClick: () => setView('settings'), 
                            className: 'w-10 h-10 text-xl', 
                            style: { color: '#808080' } 
                        }, 'âš™ï¸'),
                        React.createElement('button', { 
                            onClick: () => setView('new'), 
                            className: 'w-10 h-10 text-2xl', 
                            style: { color: '#808080' } 
                        }, 'âž•')
                    ),
                    React.createElement('div', { 
                        className: 'flex gap-6 px-4 pt-4 overflow-x-auto scroll-hidden' 
                    },
                        ['all', 'progress', 'completed', 'drafts'].map(tab =>
                            React.createElement('button', {
                                key: tab,
                                onClick: () => setActiveTab(tab),
                                className: 'pb-2 whitespace-nowrap ' + (activeTab === tab ? 'tab-active' : ''),
                                style: { color: activeTab === tab ? 'white' : '#808080' }
                            }, tab === 'all' ? 'Ð’ÑÐµ' : tab === 'progress' ? 'Ð’ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐµ' : tab === 'completed' ? 'Ð—Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½Ð½Ñ‹Ðµ' : 'Ð§ÐµÑ€Ð½Ð¾Ð²Ð¸ÐºÐ¸')
                        )
                    ),
                    React.createElement('div', { 
                        className: 'flex items-center justify-between px-4 py-3' 
                    },
                        React.createElement('span', { 
                            style: { color: '#808080' } 
                        }, filtered.length + ' Ð²ÑÐµÐ³Ð¾'),
                        React.createElement('select', {
                            value: sortBy,
                            onChange: (ev) => setSortBy(ev.target.value),
                            className: 'px-4 py-2 rounded-full outline-none',
                            style: { background: '#202020', color: '#808080' }
                        },
                            React.createElement('option', { value: 'date' }, 'ÐŸÐ¾ Ð´Ð°Ñ‚Ðµ'),
                            React.createElement('option', { value: 'title' }, 'ÐŸÐ¾ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸ÑŽ')
                        )
                    ),
                    React.createElement('div', { className: 'px-4 space-y-3' },
                        filtered.length === 0 ?
                            React.createElement('div', { className: 'text-center py-20' },
                                React.createElement('div', { className: 'text-6xl mb-4' }, 'ðŸ“'),
                                React.createElement('p', { style: { color: '#808080' } }, 'ÐŸÐ¾ÐºÐ° Ð½ÐµÑ‚ Ð¿Ñ€Ð¾Ð¸Ð·Ð²ÐµÐ´ÐµÐ½Ð¸Ð¹')
                            )
                            : filtered.map(p => {
                                let w = 0;
                                let c = 0;
                                if (p.volumes) {
                                    p.volumes.forEach(v => {
                                        v.chapters.forEach(ch => {
                                            if (!ch.isDraft) {
                                                w += ch.content.split(/\s+/).filter(x => x).length;
                                                c++;
                                            }
                                        });
                                    });
                                }
                                return React.createElement('div', {
                                    key: p.id,
                                    onClick: () => openProject(p),
                                    className: 'flex gap-3 p-3 rounded-2xl cursor-pointer',
                                    style: { background: '#202020' }
                                },
                                    p.poster ?
                                        React.createElement('img', { 
                                            src: p.poster, 
                                            className: 'w-24 h-32 object-cover rounded-xl flex-shrink-0' 
                                        })
                                        : React.createElement('div', { 
                                            className: 'w-24 h-32 flex items-center justify-center rounded-xl text-4xl flex-shrink-0', 
                                            style: { background: '#494458' } 
                                        }, 'ðŸ“–'),
                                    React.createElement('div', { className: 'flex-1 min-w-0' },
                                        React.createElement('h3', { 
                                            className: 'font-bold text-white mb-1 truncate' 
                                        }, p.title),
                                        React.createElement('p', { 
                                            className: 'text-sm mb-2', 
                                            style: { color: '#808080' } 
                                        }, c + ' Ð³Ð»Ð°Ð² â€¢ ' + w + ' ÑÐ»Ð¾Ð²'),
                                        p.description && React.createElement('p', { 
                                            className: 'text-sm line-clamp-2', 
                                            style: { color: '#808080' } 
                                        }, p.description),
                                        p.genres && React.createElement('div', { className: 'flex gap-2 mt-2' },
                                            p.genres.split(',').slice(0, 2).map((g, i) =>
                                                React.createElement('span', { 
                                                    key: i, 
                                                    className: 'text-xs px-2 py-1 rounded', 
                                                    style: { background: '#494458', color: 'white' } 
                                                }, g.trim())
                                            )
                                        )
                                    ),
                                    React.createElement('button', { 
                                        onClick: (ev) => deleteProject(p.id, ev), 
                                        className: 'text-xl', 
                                        style: { color: '#808080' } 
                                    }, 'â‹®')
                                );
                            })
                    ),
                    React.createElement('div', { 
                        className: 'fixed bottom-0 left-0 right-0 flex justify-around p-4', 
                        style: { background: '#202020' } 
                    },
                        React.createElement('button', { 
                            onClick: () => setView('library'), 
                            className: 'flex flex-col items-center gap-1' 
                        },
                            React.createElement('div', { className: 'text-2xl' }, 'ðŸ“š'),
                            React.createElement('span', { 
                                className: 'text-xs', 
                                style: { color: 'white' } 
                            }, 'Ð‘Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ°')
                        ),
                        React.createElement('button', { 
                            onClick: () => setView('profile'), 
                            className: 'flex flex-col items-center gap-1' 
                        },
                            React.createElement('div', { className: 'text-2xl' }, 'ðŸ‘¤'),
                            React.createElement('span', { 
                                className: 'text-xs', 
                                style: { color: '#808080' } 
                            }, 'ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ')
                        )
                    )
                );
            }

            return React.createElement('div', { 
                className: 'min-h-screen flex items-center justify-center p-6' 
           